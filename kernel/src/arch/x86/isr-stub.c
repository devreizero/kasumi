#include <macros.h>

#ifndef ARCH_64
    #define PUSHAD "pushad"
    #define POPAD "popad"
#else
    #define PUSHAD    \
        "push %rax\n" \
        "push %rcx\n" \
        "push %rdx\n" \
        "push %rdi\n" \
        "push %rsi\n" \
        "push %r8\n"  \
        "push %r9\n"  \
        "push %r10\n" \
        "push %r11\n"

    #define POPAD    \
        "pop %r11\n" \
        "pop %r10\n" \
        "pop %r9\n"  \
        "pop %r8\n"  \
        "pop %rsi\n" \
        "pop %rdi\n" \
        "pop %rdx\n" \
        "pop %rcx\n" \
        "pop %rax\n"
#endif

/////////////////////////////////////////////////////////////////////////////////////

__naked_section(".isr") 
void isrCommonStub() {
    __asm__ volatile (
        PUSHAD
        "cld\n"
        "leaq (%rsp), %rdi\n"
        "call exceptionHandler\n"
        POPAD
        "addq $0x10, %rsp\n"
        "iretq\n"
    );
}

__naked_section(".irq") 
void irqCommonStub() {
    __asm__ volatile (
        PUSHAD
        "cld\n"
        "leaq (%rsp), %rdi\n"
        "call irqHandler\n"
        POPAD
        "addq $0x10, %rsp\n"
        "iretq\n"
    );
}

/////////////////////////////////////////////////////////////////////////////////////

#define ISR_NOERR_STUB(n)       \
__naked_section(".isr")         \
void isrStub##n(void) {         \
    __asm__ volatile (          \
        "push $0\n"             \
        "push $" #n "\n"        \
        "jmp isrCommonStub\n"   \
    );                          \
}

#define ISR_ERR_STUB(n)         \
__naked_section(".isr")         \
void isrStub##n(void) {         \
    __asm__ volatile (          \
        "push $" #n "\n"        \
        "jmp isrCommonStub\n"   \
    );                          \
}

ISR_NOERR_STUB(0) ISR_NOERR_STUB(1) ISR_NOERR_STUB(2) ISR_NOERR_STUB(3) ISR_NOERR_STUB(4) ISR_NOERR_STUB(5) ISR_NOERR_STUB(6) ISR_NOERR_STUB(7)
ISR_ERR_STUB(8)
ISR_NOERR_STUB(9)
ISR_ERR_STUB(10) ISR_ERR_STUB(11) ISR_ERR_STUB(12) ISR_ERR_STUB(13) ISR_ERR_STUB(14)
ISR_NOERR_STUB(15) ISR_NOERR_STUB(16)
ISR_ERR_STUB(17)
ISR_NOERR_STUB(18) ISR_NOERR_STUB(19) ISR_NOERR_STUB(20) ISR_NOERR_STUB(21) ISR_NOERR_STUB(22) ISR_NOERR_STUB(23) ISR_NOERR_STUB(24)
ISR_NOERR_STUB(25) ISR_NOERR_STUB(26) ISR_NOERR_STUB(27) ISR_NOERR_STUB(28) ISR_NOERR_STUB(29)
ISR_ERR_STUB(30)
ISR_NOERR_STUB(31)

/////////////////////////////////////////////////////////////////////////////////////

#define IRQ_STUB(n)             \
__naked_section(".irq")         \
void irqStub##n(void) {         \
    __asm__ volatile (          \
        "push $" #n "\n"        \
        "jmp irqCommonStub\n"   \
    );                          \
}

IRQ_STUB(32) IRQ_STUB(33) IRQ_STUB(34) IRQ_STUB(35) IRQ_STUB(36) IRQ_STUB(37) IRQ_STUB(38) IRQ_STUB(39)
IRQ_STUB(40) IRQ_STUB(41) IRQ_STUB(42) IRQ_STUB(43) IRQ_STUB(44) IRQ_STUB(45) IRQ_STUB(46) IRQ_STUB(47) IRQ_STUB(48) IRQ_STUB(49)
IRQ_STUB(50) IRQ_STUB(51) IRQ_STUB(52) IRQ_STUB(53) IRQ_STUB(54) IRQ_STUB(55) IRQ_STUB(56) IRQ_STUB(57) IRQ_STUB(58) IRQ_STUB(59)
IRQ_STUB(60) IRQ_STUB(61) IRQ_STUB(62) IRQ_STUB(63) IRQ_STUB(64) IRQ_STUB(65) IRQ_STUB(66) IRQ_STUB(67) IRQ_STUB(68) IRQ_STUB(69)
IRQ_STUB(70) IRQ_STUB(71) IRQ_STUB(72) IRQ_STUB(73) IRQ_STUB(74) IRQ_STUB(75) IRQ_STUB(76) IRQ_STUB(77) IRQ_STUB(78) IRQ_STUB(79)
IRQ_STUB(80) IRQ_STUB(81) IRQ_STUB(82) IRQ_STUB(83) IRQ_STUB(84) IRQ_STUB(85) IRQ_STUB(86) IRQ_STUB(87) IRQ_STUB(88) IRQ_STUB(89)
IRQ_STUB(90) IRQ_STUB(91) IRQ_STUB(92) IRQ_STUB(93) IRQ_STUB(94) IRQ_STUB(95) IRQ_STUB(96) IRQ_STUB(97) IRQ_STUB(98) IRQ_STUB(99)
IRQ_STUB(100) IRQ_STUB(101) IRQ_STUB(102) IRQ_STUB(103) IRQ_STUB(104) IRQ_STUB(105) IRQ_STUB(106) IRQ_STUB(107) IRQ_STUB(108) IRQ_STUB(109)
IRQ_STUB(110) IRQ_STUB(111) IRQ_STUB(112) IRQ_STUB(113) IRQ_STUB(114) IRQ_STUB(115) IRQ_STUB(116) IRQ_STUB(117) IRQ_STUB(118) IRQ_STUB(119)
IRQ_STUB(120) IRQ_STUB(121) IRQ_STUB(122) IRQ_STUB(123) IRQ_STUB(124) IRQ_STUB(125) IRQ_STUB(126) IRQ_STUB(127) IRQ_STUB(128) IRQ_STUB(129)
IRQ_STUB(130) IRQ_STUB(131) IRQ_STUB(132) IRQ_STUB(133) IRQ_STUB(134) IRQ_STUB(135) IRQ_STUB(136) IRQ_STUB(137) IRQ_STUB(138) IRQ_STUB(139)
IRQ_STUB(140) IRQ_STUB(141) IRQ_STUB(142) IRQ_STUB(143) IRQ_STUB(144) IRQ_STUB(145) IRQ_STUB(146) IRQ_STUB(147) IRQ_STUB(148) IRQ_STUB(149)
IRQ_STUB(150) IRQ_STUB(151) IRQ_STUB(152) IRQ_STUB(153) IRQ_STUB(154) IRQ_STUB(155) IRQ_STUB(156) IRQ_STUB(157) IRQ_STUB(158) IRQ_STUB(159)
IRQ_STUB(160) IRQ_STUB(161) IRQ_STUB(162) IRQ_STUB(163) IRQ_STUB(164) IRQ_STUB(165) IRQ_STUB(166) IRQ_STUB(167) IRQ_STUB(168) IRQ_STUB(169)
IRQ_STUB(170) IRQ_STUB(171) IRQ_STUB(172) IRQ_STUB(173) IRQ_STUB(174) IRQ_STUB(175) IRQ_STUB(176) IRQ_STUB(177) IRQ_STUB(178) IRQ_STUB(179)
IRQ_STUB(180) IRQ_STUB(181) IRQ_STUB(182) IRQ_STUB(183) IRQ_STUB(184) IRQ_STUB(185) IRQ_STUB(186) IRQ_STUB(187) IRQ_STUB(188) IRQ_STUB(189)
IRQ_STUB(190) IRQ_STUB(191) IRQ_STUB(192) IRQ_STUB(193) IRQ_STUB(194) IRQ_STUB(195) IRQ_STUB(196) IRQ_STUB(197) IRQ_STUB(198) IRQ_STUB(199)
IRQ_STUB(200) IRQ_STUB(201) IRQ_STUB(202) IRQ_STUB(203) IRQ_STUB(204) IRQ_STUB(205) IRQ_STUB(206) IRQ_STUB(207) IRQ_STUB(208) IRQ_STUB(209)
IRQ_STUB(210) IRQ_STUB(211) IRQ_STUB(212) IRQ_STUB(213) IRQ_STUB(214) IRQ_STUB(215) IRQ_STUB(216) IRQ_STUB(217) IRQ_STUB(218) IRQ_STUB(219)
IRQ_STUB(220) IRQ_STUB(221) IRQ_STUB(222) IRQ_STUB(223) IRQ_STUB(224) IRQ_STUB(225) IRQ_STUB(226) IRQ_STUB(227) IRQ_STUB(228) IRQ_STUB(229)
IRQ_STUB(230) IRQ_STUB(231) IRQ_STUB(232) IRQ_STUB(233) IRQ_STUB(234) IRQ_STUB(235) IRQ_STUB(236) IRQ_STUB(237) IRQ_STUB(238) IRQ_STUB(239)
IRQ_STUB(240) IRQ_STUB(241) IRQ_STUB(242) IRQ_STUB(243) IRQ_STUB(244) IRQ_STUB(245) IRQ_STUB(246) IRQ_STUB(247) IRQ_STUB(248) IRQ_STUB(249)
IRQ_STUB(250) IRQ_STUB(251) IRQ_STUB(252) IRQ_STUB(253) IRQ_STUB(254) IRQ_STUB(255)

/////////////////////////////////////////////////////////////////////////////////////

#define ISR_PTR(n) isrStub##n
#define IRQ_PTR(n) irqStub##n

void *isrStubTable[32] = {
    ISR_PTR(0),  ISR_PTR(1),  ISR_PTR(2),  ISR_PTR(3),  ISR_PTR(4),  ISR_PTR(5),  ISR_PTR(6),  ISR_PTR(7),  ISR_PTR(8),  ISR_PTR(9), 
    ISR_PTR(10), ISR_PTR(11), ISR_PTR(12), ISR_PTR(13), ISR_PTR(14), ISR_PTR(15), ISR_PTR(16), ISR_PTR(17), ISR_PTR(18), ISR_PTR(19),
    ISR_PTR(20), ISR_PTR(21), ISR_PTR(22), ISR_PTR(23), ISR_PTR(24), ISR_PTR(25), ISR_PTR(26), ISR_PTR(27), ISR_PTR(28), ISR_PTR(29),
    ISR_PTR(30), ISR_PTR(31)
};

void *irqStubTable[256-32] = {
    IRQ_PTR(32), IRQ_PTR(33), IRQ_PTR(34), IRQ_PTR(35), IRQ_PTR(36), IRQ_PTR(37), IRQ_PTR(38), IRQ_PTR(39),
    IRQ_PTR(40), IRQ_PTR(41), IRQ_PTR(42), IRQ_PTR(43), IRQ_PTR(44), IRQ_PTR(45), IRQ_PTR(46), IRQ_PTR(47), IRQ_PTR(48), IRQ_PTR(49),
    IRQ_PTR(50), IRQ_PTR(51), IRQ_PTR(52), IRQ_PTR(53), IRQ_PTR(54), IRQ_PTR(55), IRQ_PTR(56), IRQ_PTR(57), IRQ_PTR(58), IRQ_PTR(59),
    IRQ_PTR(60), IRQ_PTR(61), IRQ_PTR(62), IRQ_PTR(63), IRQ_PTR(64), IRQ_PTR(65), IRQ_PTR(66), IRQ_PTR(67), IRQ_PTR(68), IRQ_PTR(69),
    IRQ_PTR(70), IRQ_PTR(71), IRQ_PTR(72), IRQ_PTR(73), IRQ_PTR(74), IRQ_PTR(75), IRQ_PTR(76), IRQ_PTR(77), IRQ_PTR(78), IRQ_PTR(79),
    IRQ_PTR(80), IRQ_PTR(81), IRQ_PTR(82), IRQ_PTR(83), IRQ_PTR(84), IRQ_PTR(85), IRQ_PTR(86), IRQ_PTR(87), IRQ_PTR(88), IRQ_PTR(89),
    IRQ_PTR(90), IRQ_PTR(91), IRQ_PTR(92), IRQ_PTR(93), IRQ_PTR(94), IRQ_PTR(95), IRQ_PTR(96), IRQ_PTR(97), IRQ_PTR(98), IRQ_PTR(99),
    IRQ_PTR(100), IRQ_PTR(101), IRQ_PTR(102), IRQ_PTR(103), IRQ_PTR(104), IRQ_PTR(105), IRQ_PTR(106), IRQ_PTR(107), IRQ_PTR(108), IRQ_PTR(109),
    IRQ_PTR(110), IRQ_PTR(111), IRQ_PTR(112), IRQ_PTR(113), IRQ_PTR(114), IRQ_PTR(115), IRQ_PTR(116), IRQ_PTR(117), IRQ_PTR(118), IRQ_PTR(119),
    IRQ_PTR(120), IRQ_PTR(121), IRQ_PTR(122), IRQ_PTR(123), IRQ_PTR(124), IRQ_PTR(125), IRQ_PTR(126), IRQ_PTR(127), IRQ_PTR(128), IRQ_PTR(129),
    IRQ_PTR(130), IRQ_PTR(131), IRQ_PTR(132), IRQ_PTR(133), IRQ_PTR(134), IRQ_PTR(145), IRQ_PTR(146), IRQ_PTR(147), IRQ_PTR(138), IRQ_PTR(139),
    IRQ_PTR(140), IRQ_PTR(141), IRQ_PTR(142), IRQ_PTR(143), IRQ_PTR(144), IRQ_PTR(145), IRQ_PTR(146), IRQ_PTR(147), IRQ_PTR(148), IRQ_PTR(149),
    IRQ_PTR(150), IRQ_PTR(151), IRQ_PTR(152), IRQ_PTR(153), IRQ_PTR(154), IRQ_PTR(155), IRQ_PTR(156), IRQ_PTR(157), IRQ_PTR(158), IRQ_PTR(159),
    IRQ_PTR(160), IRQ_PTR(161), IRQ_PTR(162), IRQ_PTR(163), IRQ_PTR(164), IRQ_PTR(165), IRQ_PTR(166), IRQ_PTR(167), IRQ_PTR(168), IRQ_PTR(169),
    IRQ_PTR(170), IRQ_PTR(171), IRQ_PTR(172), IRQ_PTR(173), IRQ_PTR(174), IRQ_PTR(175), IRQ_PTR(176), IRQ_PTR(177), IRQ_PTR(178), IRQ_PTR(179),
    IRQ_PTR(180), IRQ_PTR(181), IRQ_PTR(182), IRQ_PTR(183), IRQ_PTR(184), IRQ_PTR(185), IRQ_PTR(186), IRQ_PTR(187), IRQ_PTR(188), IRQ_PTR(189),
    IRQ_PTR(190), IRQ_PTR(191), IRQ_PTR(192), IRQ_PTR(193), IRQ_PTR(194), IRQ_PTR(195), IRQ_PTR(196), IRQ_PTR(197), IRQ_PTR(198), IRQ_PTR(199),
    IRQ_PTR(200), IRQ_PTR(201), IRQ_PTR(202), IRQ_PTR(203), IRQ_PTR(204), IRQ_PTR(205), IRQ_PTR(206), IRQ_PTR(207), IRQ_PTR(208), IRQ_PTR(209),
    IRQ_PTR(210), IRQ_PTR(211), IRQ_PTR(212), IRQ_PTR(213), IRQ_PTR(214), IRQ_PTR(215), IRQ_PTR(216), IRQ_PTR(217), IRQ_PTR(218), IRQ_PTR(219),
    IRQ_PTR(220), IRQ_PTR(221), IRQ_PTR(222), IRQ_PTR(223), IRQ_PTR(224), IRQ_PTR(225), IRQ_PTR(226), IRQ_PTR(227), IRQ_PTR(228), IRQ_PTR(229),
    IRQ_PTR(230), IRQ_PTR(231), IRQ_PTR(232), IRQ_PTR(233), IRQ_PTR(234), IRQ_PTR(245), IRQ_PTR(246), IRQ_PTR(247), IRQ_PTR(238), IRQ_PTR(239),
    IRQ_PTR(240), IRQ_PTR(241), IRQ_PTR(242), IRQ_PTR(243), IRQ_PTR(244), IRQ_PTR(245), IRQ_PTR(246), IRQ_PTR(247), IRQ_PTR(248), IRQ_PTR(249),
    IRQ_PTR(250), IRQ_PTR(251), IRQ_PTR(252), IRQ_PTR(253), IRQ_PTR(254), IRQ_PTR(255)
};